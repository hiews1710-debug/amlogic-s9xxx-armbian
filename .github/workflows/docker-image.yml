#==========================================================================
# Description: Build Armbian server image
# Copyright (C) 2021 https://github.com/ophub/amlogic-s9xxx-armbian
#==========================================================================

name: Build Armbian server image for Firefly-RK3399

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      set_release:
        description: "Select OS Release."
        required: false
        default: "bookworm"
        type: choice
        options:
          - bookworm
          - bullseye
          - jammy
      armbian_board:
        description: "Select device board."
        required: false
        default: "firefly-rk3399"
        type: choice
        options:
          - firefly-rk3399
      armbian_kernel:
        description: "Select kernel version."
        required: false
        default: "current"
        type: choice
        options:
          - current
          - edge
      auto_kernel:
        description: "Auto use the latest kernel."
        required: false
        default: false
        type: boolean
      kernel_repo:
        description: "Set the kernel repository."
        required: false
        default: "ophub/kernel"
        type: string
      kernel_usage:
        description: "Set the tags of the stable kernel."
        required: false
        default: "stable"
        type: choice
        options:
          - stable
          - flippy
      armbian_fstype:
        description: "Select armbian rootfs type."
        required: false
        default: "ext4"
        type: choice
        options:
          - ext4
      armbian_storage:
        description: "Select image storage type."
        required: false
        default: "save"
        type: choice
        options:
          - save
      builder_name:
        description: "Set Armbian builder signature."
        required: false
        default: "ophub"
        type: string

env:
  TZ: America/New_York

jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://tinyurl.com/ubuntu2204-build-armbian)
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create simulated physical disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner.runner /builder
          df -Th

      - name: Download Armbian build source
        id: down
        working-directory: /builder
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          df -hT ${PWD}
          echo "Downloading Armbian build source..."
          git clone -q --single-branch --depth=1 https://github.com/armbian/build.git build
          cd build
          
          # List available branches/tags
          echo "Available branches/tags:"
          git branch -a | head -20
          git tag -l | head -20
          
          # Use main branch
          echo "Using main branch..."
          
          # Create directory for patches
          mkdir -p userpatches/overlay/firefly-rk3399
          
          # Create a script to apply fixes after boot
          cat > userpatches/overlay/firefly-rk3399/99-firefly-fixes.sh << 'EOF'
          #!/bin/bash
          # Firefly RK3399 fixes
          
          echo "Applying Firefly RK3399 fixes..."
          
          # Disable PCIe if causing issues (optional - uncomment if needed)
          # sed -i 's/status = "okay"/status = "disabled"/g' /boot/dtb/rockchip/rk3399-firefly.dts
          
          # Add kernel parameters to help with stability
          if ! grep -q "pci=nomsi" /boot/armbianEnv.txt; then
            echo "extraargs=pci=nomsi" >> /boot/armbianEnv.txt
          fi
          
          # Update initramfs
          update-initramfs -u -k all
          
          echo "Firefly fixes applied."
          EOF
          
          chmod +x userpatches/overlay/firefly-rk3399/99-firefly-fixes.sh
          
          # Create custom script for post-install
          cat > userpatches/customize-image.sh << 'EOF'
          #!/bin/bash
          
          # This script runs inside the chroot during image build
          
          # Add Firefly-specific packages
          apt-get update
          apt-get install -y rockchip-overlay i2c-tools lm-sensors
          
          # Disable problematic services if they exist
          systemctl disable pcie-rockchip-host 2>/dev/null || true
          
          # Add udev rule for better device recognition
          cat > /etc/udev/rules.d/99-firefly.rules << 'EOR'
          # Firefly RK3399 udev rules
          SUBSYSTEM=="drm", ACTION=="change", RUN+="/usr/bin/logger DRM event detected"
          EOR
          
          # Create systemd service for Firefly fixes
          cat > /etc/systemd/system/firefly-fixes.service << 'EOS'
          [Unit]
          Description=Apply Firefly RK3399 fixes
          After=network.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/apply-firefly-fixes
          RemainAfterExit=yes
          
          [Install]
          WantedBy=multi-user.target
          EOS
          
          # Copy fix script
          cp /tmp/overlay/firefly-rk3399/99-firefly-fixes.sh /usr/local/bin/apply-firefly-fixes
          chmod +x /usr/local/bin/apply-firefly-fixes
          
          systemctl enable firefly-fixes.service
          
          echo "Firefly RK3399 customization complete."
          EOF
          
          chmod +x userpatches/customize-image.sh
          
          # Create minimal config file
          cat > userpatches/config-firefly.conf << 'EOF'
          # Firefly RK3399 configuration
          BUILD_MINIMAL="no"
          BUILD_DESKTOP="no"
          KERNEL_CONFIGURE="no"
          KERNEL_KEEP_CONFIG="no"
          EXPERT="yes"
          FORCE_BOOTSCRIPT_UPDATE="yes"
          BSPFREEZE="no"
          CREATE_PATCHES="no"
          INSTALL_HEADERS="no"
          COMPRESS_OUTPUT="img,xz"
          EOF
          
          ln -sf /builder/build ${GITHUB_WORKSPACE}/build
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Compile Armbian for Firefly-RK3399
        id: compile
        working-directory: /builder/build
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "Starting Armbian build for Firefly-RK3399..."
          
          # First, let's check what boards are available
          echo "Available boards:"
          ./compile.sh list boards | grep -i firefly || true
          
          # Try with simpler configuration
          # Using current branch (6.1.y kernel) which should work better with RK3399
          sudo ./compile.sh \
            BOARD=firefly-rk3399 \
            BRANCH=current \
            RELEASE=${{ inputs.set_release }} \
            KERNEL_ONLY=no \
            KERNEL_CONFIGURE=no \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=no \
            EXPERT=no \
            COMPRESS_OUTPUTIMAGE=img \
            ROOTFSTYPE=ext4 \
            BSPFREEZE=no \
            EXTRAWIFI=no \
            CREATE_PATCHES=no \
            INSTALL_HEADERS=no \
            KERNEL_GIT=shallow \
            USE_TORRENT=no \
            CACHE_DIR=/builder/cache \
            EXTERNAL=no
          
          # Check if build was successful
          if [ -f output/images/Armbian*.img ] || [ -f output/images/Armbian*.img.xz ] || [ -f output/images/Armbian*.img.gz ]; then
            echo "status=success" >> ${GITHUB_OUTPUT}
            echo "Build completed successfully!"
          else
            # Try alternative approach with edge branch
            echo "Trying with edge branch..."
            sudo ./compile.sh \
              BOARD=firefly-rk3399 \
              BRANCH=edge \
              RELEASE=${{ inputs.set_release }} \
              KERNEL_ONLY=no \
              KERNEL_CONFIGURE=no \
              BUILD_DESKTOP=no \
              BUILD_MINIMAL=no \
              EXPERT=yes \
              COMPRESS_OUTPUTIMAGE=img
            
            if [ -f output/images/Armbian*.img ] || [ -f output/images/Armbian*.img.xz ] || [ -f output/images/Armbian*.img.gz ]; then
              echo "status=success" >> ${GITHUB_OUTPUT}
              echo "Build completed successfully with edge branch!"
            else
              echo "status=failed" >> ${GITHUB_OUTPUT}
              echo "ERROR: Build failed - no image found!"
              exit 1
            fi
          fi

      - name: Organize files and clear space
        id: clean
        if: ${{ steps.compile.outputs.status == 'success' && !cancelled() }}
        run: |
          echo "Organizing build artifacts..."
          
          # Create output directory
          mkdir -p ${GITHUB_WORKSPACE}/output
          
          # Find and copy the built image
          cd /builder/build/output/images
          
          # Look for image files
          IMAGE_FILE=$(ls -t Armbian*.img Armbian*.img.xz Armbian*.img.gz 2>/dev/null | head -1)
          
          if [ -n "$IMAGE_FILE" ]; then
            echo "Found image: $IMAGE_FILE"
            
            # Show image info
            ls -lh "$IMAGE_FILE"
            
            # Copy to workspace
            cp "$IMAGE_FILE" ${GITHUB_WORKSPACE}/output/
            
            # If it's not compressed, compress it
            if [[ "$IMAGE_FILE" == *.img ]]; then
              echo "Compressing image..."
              gzip -9 -c "$IMAGE_FILE" > ${GITHUB_WORKSPACE}/output/"${IMAGE_FILE}.gz"
              # Also keep original for checksum
              cp "$IMAGE_FILE" ${GITHUB_WORKSPACE}/output/
            fi
            
            # Generate SHA256 checksum
            cd ${GITHUB_WORKSPACE}/output
            for file in *; do
              if [[ "$file" != sha256sum.txt ]]; then
                sha256sum "$file" >> sha256sum.txt
              fi
            done
            
            # List files
            echo "Files in output directory:"
            ls -la
            
            # Get kernel version from image filename if possible
            KERNEL_VERSION="current"
            if [[ "$IMAGE_FILE" =~ kernel([0-9]+\.[0-9]+) ]]; then
              KERNEL_VERSION="${BASH_REMATCH[1]}"
            fi
            
            echo "build_tag=Armbian_${{ inputs.set_release }}_firefly-rk3399_k${KERNEL_VERSION}_$(date +"%Y%m%d")" >> ${GITHUB_OUTPUT}
            echo "status=success" >> ${GITHUB_OUTPUT}
          else
            echo "ERROR: No image file found in output/images/"
            echo "Available files:"
            ls -la /builder/build/output/images/ || true
            echo "status=failed" >> ${GITHUB_OUTPUT}
            exit 1
          fi
          
          # Clean up
          echo "Cleaning up build space..."
          sudo rm -rf /builder/build/{cache,output} 2>/dev/null || true
          df -hT /builder

      - name: Upload Armbian image to Release
        uses: ncipollo/release-action@main
        if: ${{ steps.clean.outputs.status == 'success' && !cancelled() }}
        with:
          tag: ${{ steps.clean.outputs.build_tag }}
          artifacts: output/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian for Firefly-RK3399
            - **OS**: ${{ inputs.set_release }}
            - **Kernel**: Current branch (6.1.y+) 
            - **Board**: Firefly-RK3399
            - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### Default Credentials
            - **Username**: root
            - **Password**: 1234
            
            ### Important Notes:
            1. This build uses the **current** kernel branch (6.1.y+)
            2. Includes basic Rockchip BSP packages
            3. Console on **ttyS2** (1500000 baud)
            
            ### Installation:
            ```bash
            # Write to SD card (for .gz files)
            gunzip -c Armbian_*.img.gz | sudo dd of=/dev/sdX bs=4M status=progress
            
            # For .img files
            sudo dd if=Armbian_*.img of=/dev/sdX bs=4M status=progress
            
            # For .xz files
            xzcat Armbian_*.img.xz | sudo dd of=/dev/sdX bs=4M status=progress
            ```
            
            ### First Boot:
            1. Insert SD card into Firefly-RK3399
            2. Power on the board
            3. Login with root/1234
            4. Run `armbian-config` for additional configuration
            
            ### If you encounter PCIe errors:
            Edit `/boot/armbianEnv.txt` and add:
            ```
            extraargs=pci=nomsi
            ```
            Then reboot.
            
            ### Verification:
            ```bash
            sha256sum -c sha256sum.txt
            ```

      - name: Cleanup workspace
        if: always()
        run: |
          echo "Cleaning up workspace..."
          sudo umount /builder 2>/dev/null || true
          sudo vgremove -f github 2>/dev/null || true
          sudo pvremove /dev/loop6 /dev/loop7 2>/dev/null || true
          sudo losetup -d /dev/loop6 /dev/loop7 2>/dev/null || true
          sudo rm -f /mnt/mnt.img /root.img 2>/dev/null || true
          echo "Cleanup completed"
