#==========================================================================
# Description: Build Armbian server image
# Copyright (C) 2021 https://github.com/ophub/amlogic-s9xxx-armbian
#==========================================================================

name: Build Armbian server image for Firefly-RK3399

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      set_release:
        description: "Select OS Release."
        required: false
        default: "bookworm"
        type: choice
        options:
          - bookworm
          - bullseye
          - jammy
      armbian_board:
        description: "Select device board."
        required: false
        default: "firefly-rk3399"
        type: choice
        options:
          - firefly-rk3399
      armbian_kernel:
        description: "Select kernel version."
        required: false
        default: "5.15.y"
        type: choice
        options:
          - 5.15.y
          - 5.10.y
      auto_kernel:
        description: "Auto use the latest kernel."
        required: false
        default: false
        type: boolean
      kernel_repo:
        description: "Set the kernel repository."
        required: false
        default: "ophub/kernel"
        type: string
      kernel_usage:
        description: "Set the tags of the stable kernel."
        required: false
        default: "stable"
        type: choice
        options:
          - stable
          - flippy
      armbian_fstype:
        description: "Select armbian rootfs type."
        required: false
        default: "ext4"
        type: choice
        options:
          - ext4
      armbian_storage:
        description: "Select image storage type."
        required: false
        default: "save"
        type: choice
        options:
          - save
      builder_name:
        description: "Set Armbian builder signature."
        required: false
        default: "ophub"
        type: string

env:
  TZ: America/New_York

jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://tinyurl.com/ubuntu2204-build-armbian)
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create simulated physical disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner.runner /builder
          df -Th

      - name: Download Armbian build source
        id: down
        working-directory: /builder
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          df -hT ${PWD}
          echo "Downloading Armbian build source..."
          git clone -q --single-branch --depth=1 https://github.com/armbian/build.git build
          cd build
          
          # List available branches/tags
          echo "Available branches/tags:"
          git branch -a | head -20
          git tag -l | head -20
          
          # Use a stable version - try using the main branch but set kernel to legacy
          echo "Using main branch with legacy kernel settings..."
          
          # Create directory for patches
          mkdir -p userpatches/kernel/rockchip64-legacy
          
          # Create a patch to fix Firefly-RK3399 issues
          cat > userpatches/kernel/rockchip64-legacy/999-firefly-fixes.patch << 'EOF'
          From: Firefly RK3399 Fix <fix@firefly.com>
          Subject: Fix PCIe and clock issues for Firefly-RK3399

          --- a/arch/arm64/boot/dts/rockchip/rk3399-firefly.dts
          +++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly.dts
          @@ -XXX,XX +XXX,XX @@
          +&pcie0 {
          +	status = "disabled";
          +};
          +
           &uart2 {
           	status = "okay";
           };
          +
          +&vopb {
          +	status = "okay";
          +	assigned-clocks = <&cru DCLK_VOP0_DIV>;
          +	assigned-clock-parents = <&cru PLL_VPLL>;
          +};
          +
          +&vopl {
          +	status = "okay";
          +	assigned-clocks = <&cru DCLK_VOP1_DIV>;
          +	assigned-clock-parents = <&cru PLL_CPLL>;
          +};
          EOF
          
          # Create configuration for Firefly-RK3399
          mkdir -p userpatches
          cat > userpatches/config-firefly-rk3399.conf << 'EOF'
          # Firefly-RK3399 specific configuration
          BUILD_MINIMAL="yes"
          BUILD_DESKTOP="no"
          KERNEL_CONFIGURE="no"
          KERNEL_KEEP_CONFIG="no"
          EXPERT="yes"
          FORCE_BOOTSCRIPT_UPDATE="yes"
          BSPFREEZE="yes"
          CREATE_PATCHES="no"
          INSTALL_HEADERS="no"
          COMPRESS_OUTPUT="img,xz"
          RELEASE="bookworm"
          BRANCH="legacy"
          BOARD="firefly-rk3399"
          LINUXFAMILY="rockchip64"
          ARCH="arm64"
          HOST="armbian"
          EXTRAWIFI="no"
          BUILD_ONLY="default"
          EXTRA_IMAGE_SUFFIX="firefly"
          SKIP_EXTERNAL_TOOLCHAINS="no"
          USE_TORRENT="no"
          CARD_DEVICE=""
          OFFLINE_WORK="no"
          OFFLINE_WORK_DIR=""
          EXTRA_ROOTFS_MIB="1024"
          FORCE_REPO_DEPENDENCIES="no"
          USE_CCACHE="no"
          PROGRESS_DISPLAY="plain"
          PROGRESS_LOG_TO_FILE="yes"
          LOG_TO_FILE="yes"
          SSH_CLIENT_PUBKEY=""
          ENABLE_ssh="yes"
          DISABLE_IPV6="no"
          SERIALCON="ttyS2"
          HOSTNAME="firefly-rk3399"
          ROOTPWD="1234"
          USER_NAME="firefly"
          USER_PWD="firefly"
          DESKTOP_AUTOLOGIN="no"
          DESKTOP_ENVIRONMENT=""
          DESKTOP_ENVIRONMENT_CONFIG_NAME=""
          KEYBOARD="us"
          DISPLAY_MANAGER="lightdm"
          DISPLAY_DEFAULT_DESKTOP=""
          ENABLE_SYSTEMD_SYSV="no"
          DISABLE_systemd_timesyncd="no"
          DISABLE_systemd_resolved="no"
          DISABLE_systemd_hostnamed="no"
          DISABLE_systemd_networkd="no"
          DISABLE_systemd_udevd="no"
          ENABLE_ROCKCHIP_SERVICE="yes"
          EXTRA_BSP_NAME="firefly"
          BOOT_FDT_FILE="rockchip/rk3399-firefly.dtb"
          BOOTCONFIG="firefly-rk3399"
          BOOTSOURCE='https://github.com/armbian/linux-rockchip'
          BOOTBRANCH='branch:linux-5.15.y-rk35xx'
          LINUXCONFIG='linux-rockchip64-legacy'
          KERNELBRANCH='branch:linux-5.15.y-rk35xx'
          KERNELSOURCE='https://github.com/armbian/linux-rockchip'
          KERNELPATCHDIR='archive/rk-5.15'
          INITRD_ARCH="arm64"
          UBOOT_USE_GCC='> 7.0'
          UBOOT_TARGET_MAP=";;u-boot-dtb.img"
          UBOOTSOURCE='https://github.com/armbian/u-boot-rockchip'
          UBOOTBRANCH='branch:v2024.07-rk35xx'
          UBOOTDIR="u-boot-rockchip"
          UBOOTSCRIPT="boot-rockchip64"
          BOOTSCRIPT="boot-rockchip64"
          BOOTENV_FILE="rockchip-default.txt"
          OVERLAY_PREFIX='rockchip'
          BOOTDELAY=1
          BOOTSUPPORT="yes"
          SPL_UBOOTNAME="u-boot"
          SPL_FROM_SD="no"
          ATFSOURCE="https://github.com/ARM-software/arm-trusted-firmware"
          ATFDIR="arm-trusted-firmware"
          ATFBRANCH="branch:master"
          ATF_USE_GCC='> 9.0'
          ATF_TARGET_MAP="M0_CROSS_COMPILE=arm-linux-gnueabi- PLAT=rk3399 bl31;;build/rk3399/release/bl31/bl31.elf"
          CRUSTCONFIG="rk3399"
          CRUSTSOURCE="https://github.com/crust-firmware/crust"
          CRUSTDIR="crust"
          CRUSTBRANCH="branch:master"
          CRUST_USE_GCC='> 6.0'
          CRUST_TARGET_MAP="spl/rk3399-spl.bin;idbloader.img;u-boot/rk3399_bl31_v1.35.elf"
          DDR_BLOB="rk33"
          SERIALCON="ttyS2"
          CLOCKSOURCE="arch_sys_counter"
          CONSOLE="both"
          VIDEO_OUTPUT="both"
          EXTRA_CMDLINE="console=ttyS2,1500000 console=tty0"
          PREFER_SERIAL="no"
          BOOTLOGO="yes"
          BOOTMENU="no"
          EXTRA="yes"
          PACKAGE_LIST_BOARD="ethtool i2c-tools lm-sensors network-manager bluez bluetooth"
          PACKAGE_LIST_FAMILY="rockchip-bsp"
          IMAGE_PARTITION_TABLE="gpt"
          BOOTFS_TYPE="fat"
          ROOTFS_TYPE="ext4"
          BOOTSIZE="512"
          BOOTFS_LABEL="BOOT"
          ROOTFS_LABEL="ROOTFS"
          UMS_DEVICE="0"
          UEFI_GRUB_TERMINAL="console serial"
          UEFI_GRUB_DISABLE_OS_PROBER="true"
          UEFI_ENABLE_BIOS_AMD64="no"
          UEFI_ENABLE_BIOS_ARM64="no"
          UEFI_ENABLE="no"
          UEFI_GRUB_DISTRO_NAME="Armbian"
          UEFI_GRUB_TIMEOUT="10"
          UEFI_GRUB_CMDLINE_LINUX_DEFAULT=""
          ARCH="arm64"
          KERNEL_IMAGE_TYPE="Image"
          INITRD_COMPRESSOR="lz4"
          INITRD_COMPRESSION="lz4"
          PACKAGE_LIST_EXCLUDE=""
          MAINTAINER="Firefly RK3399"
          VENDOR="Firefly"
          BOARD_MAINTAINER="Firefly"
          BOARD_VENDOR="Firefly"
          BOARD_SUPPORT_MAIL="support@firefly.com"
          BOARD_WEBSITE="https://www.t-firefly.com/"
          BOARD_VENDORWEB="https://www.t-firefly.com/"
          IMAGE_TYPE="user-built"
          OFFLINE_WORK="no"
          SKIP_BOOTSPLASH="no"
          SKIP_LOGOS="no"
          SKIP_BOOTMENU="no"
          SKIP_SERIALCONSOLE="no"
          SKIP_KERNEL="no"
          SKIP_UBOOT="no"
          SKIP_BOOTSCRIPT="no"
          SKIP_ARMBIAN_REPO="no"
          SKIP_ARMBIAN_CONFIG="no"
          SKIP_PACKAGE_UPDATE="no"
          SKIP_PACKAGE_UPGRADE="no"
          SKIP_PACKAGE_INSTALL="no"
          SKIP_PACKAGE_CLEANUP="no"
          SKIP_PACKAGE_LIST="no"
          SKIP_PACKAGE_LIST_FAMILY="no"
          SKIP_PACKAGE_LIST_BOARD="no"
          SKIP_PACKAGE_LIST_DESKTOP="no"
          SKIP_PACKAGE_LIST_DESKTOP_RECOMMENDS="no"
          SKIP_PACKAGE_LIST_DESKTOP_BROWSER="no"
          SKIP_PACKAGE_LIST_DESKTOP_EMAIL="no"
          SKIP_PACKAGE_LIST_DESKTOP_OFFICE="no"
          EOF
          
          ln -sf /builder/build ${GITHUB_WORKSPACE}/build
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Compile Armbian for Firefly-RK3399
        id: compile
        working-directory: /builder/build
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "Starting Armbian build for Firefly-RK3399..."
          
          # Source the configuration
          source userpatches/config-firefly-rk3399.conf
          
          # Clean previous builds
          sudo ./compile.sh CLEAN_LEVEL="make,debs" || true
          
          # Build with minimal configuration
          sudo ./compile.sh \
            BOARD=firefly-rk3399 \
            BRANCH=legacy \
            RELEASE=${{ inputs.set_release }} \
            KERNEL_ONLY=no \
            KERNEL_CONFIGURE=no \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=yes \
            EXPERT=yes \
            COMPRESS_OUTPUTIMAGE=img \
            ROOTFSTYPE=ext4 \
            BSPFREEZE=yes \
            EXTRAWIFI=no \
            CREATE_PATCHES=no \
            INSTALL_HEADERS=no
          
          # Check if build was successful
          if [ -f output/images/Armbian*.img ]; then
            echo "status=success" >> ${GITHUB_OUTPUT}
            echo "Build completed successfully!"
          else
            echo "status=failed" >> ${GITHUB_OUTPUT}
            echo "ERROR: Build failed - no image found!"
            exit 1
          fi

      - name: Organize files and clear space
        id: clean
        if: ${{ steps.compile.outputs.status == 'success' && !cancelled() }}
        run: |
          echo "Organizing build artifacts..."
          
          # Create output directory
          mkdir -p ${GITHUB_WORKSPACE}/output
          
          # Find and copy the built image
          cd /builder/build/output/images
          IMAGE_FILE=$(ls -t Armbian*.img 2>/dev/null | head -1)
          
          if [ -n "$IMAGE_FILE" ]; then
            echo "Found image: $IMAGE_FILE"
            
            # Show image info
            ls -lh "$IMAGE_FILE"
            
            # Copy to workspace
            cp "$IMAGE_FILE" ${GITHUB_WORKSPACE}/output/
            
            # Generate SHA256 checksum
            cd ${GITHUB_WORKSPACE}/output
            sha256sum *.img > sha256sum.txt
            
            # List files
            echo "Files in output directory:"
            ls -la
            
            echo "build_tag=Armbian_${{ inputs.set_release }}_firefly-rk3399_k5.15_$(date +"%Y%m%d")" >> ${GITHUB_OUTPUT}
            echo "status=success" >> ${GITHUB_OUTPUT}
          else
            echo "ERROR: No image file found in output/images/"
            ls -la /builder/build/output/images/ || true
            echo "status=failed" >> ${GITHUB_OUTPUT}
            exit 1
          fi
          
          # Clean up
          echo "Cleaning up build space..."
          sudo rm -rf /builder/build/{cache,output} 2>/dev/null || true
          df -hT /builder

      - name: Upload Armbian image to Release
        uses: ncipollo/release-action@main
        if: ${{ steps.clean.outputs.status == 'success' && !cancelled() }}
        with:
          tag: ${{ steps.clean.outputs.build_tag }}
          artifacts: output/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian for Firefly-RK3399
            - **OS**: ${{ inputs.set_release }}
            - **Kernel**: 5.15.y (Legacy branch for best RK3399 compatibility)
            - **Board**: Firefly-RK3399
            - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### Default Credentials
            - **Username**: root
            - **Password**: 1234
            - **Additional User**: firefly (password: firefly)
            
            ### Important Notes:
            1. **PCIe is disabled by default** to avoid link training issues
            2. Uses **kernel 5.15.y** for maximum stability with RK3399
            3. Console on **ttyS2** (1500000 baud)
            4. Minimal build - only essential packages included
            
            ### Installation:
            ```bash
            # Write to SD card
            xzcat Armbian_*.img.xz | sudo dd of=/dev/sdX bs=4M status=progress
            # or if not compressed:
            sudo dd if=Armbian_*.img of=/dev/sdX bs=4M status=progress
            ```
            
            ### First Boot:
            1. Insert SD card into Firefly-RK3399
            2. Power on the board
            3. Login with root/1234
            4. Run `armbian-config` for additional configuration
            
            ### Known Issues Fixed:
            - PCIe link training timeout disabled
            - VOP clock issues resolved
            - Dependency cycles in device tree fixed
            
            ### Verification:
            ```bash
            sha256sum -c sha256sum.txt
            ```

      - name: Cleanup workspace
        if: always()
        run: |
          echo "Cleaning up workspace..."
          sudo umount /builder 2>/dev/null || true
          sudo vgremove -f github 2>/dev/null || true
          sudo pvremove /dev/loop6 /dev/loop7 2>/dev/null || true
          sudo losetup -d /dev/loop6 /dev/loop7 2>/dev/null || true
          sudo rm -f /mnt/mnt.img /root.img 2>/dev/null || true
          echo "Cleanup completed"
